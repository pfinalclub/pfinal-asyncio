<?php
/**
 * ç›´è§‚å±•ç¤ºå¼‚æ­¥æ‰§è¡Œæ•ˆæœ
 * 
 * é€šè¿‡æ—¶é—´æˆ³å’Œæ‰§è¡Œé¡ºåºï¼Œæ¸…æ™°çœ‹åˆ°ä»»åŠ¡çš„å¹¶å‘æ‰§è¡Œ
 */

require_once __DIR__ . '/../vendor/autoload.php';

use function PfinalClub\Asyncio\{run, sleep, create_task, gather};

echo "=== å¦‚ä½•çœ‹å‡ºå¼‚æ­¥æ‰§è¡Œï¼Ÿ===\n\n";

// è¾…åŠ©å‡½æ•°ï¼šæ‰“å°å¸¦æ—¶é—´æˆ³çš„æ¶ˆæ¯
function log_msg(string $msg): void
{
    echo sprintf("[%s] %s\n", date('H:i:s.') . substr(microtime(), 2, 3), $msg);
}

// æ¨¡æ‹Ÿä»»åŠ¡
function task(string $name, float $duration): string
{
    log_msg("{$name} - å¼€å§‹æ‰§è¡Œ");
    sleep($duration);
    log_msg("{$name} - æ‰§è¡Œå®Œæˆ");
    return "{$name} ç»“æœ";
}

// ========================================
// å¯¹æ¯” 1: é¡ºåºæ‰§è¡Œ vs å¹¶å‘æ‰§è¡Œ
// ========================================

echo "ã€å¯¹æ¯” 1ã€‘é¡ºåºæ‰§è¡Œ vs å¹¶å‘æ‰§è¡Œ\n";
echo "ä»»åŠ¡ï¼š3 ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªè€—æ—¶ 1 ç§’\n\n";

echo "--- é¡ºåºæ‰§è¡Œï¼ˆä¸€ä¸ªæ¥ä¸€ä¸ªï¼‰---\n";
$start = microtime(true);
run(function() {
    task('ä»»åŠ¡A', 1.0);
    task('ä»»åŠ¡B', 1.0);
    task('ä»»åŠ¡C', 1.0);
});
$sequential_time = microtime(true) - $start;
echo "é¡ºåºæ‰§è¡Œæ€»è€—æ—¶: " . round($sequential_time, 2) . " ç§’\n\n";

echo "--- å¹¶å‘æ‰§è¡Œï¼ˆåŒæ—¶è¿è¡Œï¼‰---\n";
$start = microtime(true);
run(function() {
    // åˆ›å»º3ä¸ªä»»åŠ¡ï¼Œå®ƒä»¬ä¼šåŒæ—¶æ‰§è¡Œ
    $t1 = create_task(fn() => task('ä»»åŠ¡A', 1.0));
    $t2 = create_task(fn() => task('ä»»åŠ¡B', 1.0));
    $t3 = create_task(fn() => task('ä»»åŠ¡C', 1.0));
    
    // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    gather($t1, $t2, $t3);
});
$concurrent_time = microtime(true) - $start;
echo "å¹¶å‘æ‰§è¡Œæ€»è€—æ—¶: " . round($concurrent_time, 2) . " ç§’\n";
echo "âš¡ é€Ÿåº¦æå‡: " . round($sequential_time / $concurrent_time, 1) . "x å€\n\n";

echo str_repeat("=", 60) . "\n\n";

// ========================================
// å¯¹æ¯” 2: çœ‹æ‰§è¡Œé¡ºåº
// ========================================

echo "ã€å¯¹æ¯” 2ã€‘è§‚å¯Ÿä»»åŠ¡äº¤é”™æ‰§è¡Œ\n";
echo "æ³¨æ„ï¼šä»»åŠ¡ä¼šäº¤é”™æ‰§è¡Œï¼Œä¸æ˜¯ä¸€ä¸ªå®Œæˆå†æ‰§è¡Œä¸‹ä¸€ä¸ª\n\n";

run(function() {
    log_msg("ä¸»ç¨‹åºå¼€å§‹");
    
    // åˆ›å»ºä»»åŠ¡ï¼ˆç«‹å³å¼€å§‹æ‰§è¡Œï¼‰
    $t1 = create_task(function() {
        log_msg("  ä»»åŠ¡1 - å¼€å§‹");
        sleep(0.3);
        log_msg("  ä»»åŠ¡1 - ä¸­é—´");
        sleep(0.3);
        log_msg("  ä»»åŠ¡1 - å®Œæˆ");
        return "ç»“æœ1";
    });
    
    $t2 = create_task(function() {
        log_msg("    ä»»åŠ¡2 - å¼€å§‹");
        sleep(0.2);
        log_msg("    ä»»åŠ¡2 - ä¸­é—´");
        sleep(0.2);
        log_msg("    ä»»åŠ¡2 - å®Œæˆ");
        return "ç»“æœ2";
    });
    
    $t3 = create_task(function() {
        log_msg("      ä»»åŠ¡3 - å¼€å§‹");
        sleep(0.15);
        log_msg("      ä»»åŠ¡3 - ä¸­é—´");
        sleep(0.15);
        log_msg("      ä»»åŠ¡3 - å®Œæˆ");
        return "ç»“æœ3";
    });
    
    log_msg("ä¸»ç¨‹åºï¼š3ä¸ªä»»åŠ¡å·²åˆ›å»ºï¼Œç­‰å¾…å®Œæˆ...");
    
    $results = gather($t1, $t2, $t3);
    
    log_msg("ä¸»ç¨‹åºï¼šæ‰€æœ‰ä»»åŠ¡å®Œæˆ");
    echo "\nçœ‹åˆ°äº†å—ï¼Ÿä»»åŠ¡æ˜¯äº¤é”™æ‰§è¡Œçš„ï¼Œä¸æ˜¯ä¸€ä¸ªæ¥ä¸€ä¸ªï¼\n";
});

echo "\n" . str_repeat("=", 60) . "\n\n";

// ========================================
// å¯¹æ¯” 3: å®é™…åº”ç”¨åœºæ™¯
// ========================================

echo "ã€å¯¹æ¯” 3ã€‘å®é™…åœºæ™¯ï¼šå¹¶å‘ HTTP è¯·æ±‚\n";
echo "æ¨¡æ‹Ÿï¼šè¯·æ±‚ 5 ä¸ª APIï¼Œæ¯ä¸ªè€—æ—¶ 0.5 ç§’\n\n";

echo "--- é¡ºåºè¯·æ±‚ ---\n";
$start = microtime(true);
run(function() {
    for ($i = 1; $i <= 5; $i++) {
        log_msg("è¯·æ±‚ API-{$i}");
        sleep(0.5);
        log_msg("API-{$i} è¿”å›");
    }
});
$seq = microtime(true) - $start;
echo "é¡ºåºè¯·æ±‚è€—æ—¶: " . round($seq, 2) . " ç§’\n\n";

echo "--- å¹¶å‘è¯·æ±‚ ---\n";
$start = microtime(true);
run(function() {
    $tasks = [];
    for ($i = 1; $i <= 5; $i++) {
        $tasks[] = create_task(function() use ($i) {
            log_msg("è¯·æ±‚ API-{$i}");
            sleep(0.5);
            log_msg("API-{$i} è¿”å›");
            return "API-{$i} æ•°æ®";
        });
    }
    gather(...$tasks);
});
$con = microtime(true) - $start;
echo "å¹¶å‘è¯·æ±‚è€—æ—¶: " . round($con, 2) . " ç§’\n";
echo "âš¡ èŠ‚çœæ—¶é—´: " . round($seq - $con, 2) . " ç§’\n\n";

// ========================================
// æ€»ç»“
// ========================================

echo str_repeat("=", 60) . "\n";
echo "âœ… å¦‚ä½•åˆ¤æ–­æ˜¯å¦å¼‚æ­¥ï¼Ÿ\n\n";
echo "1. çœ‹æ—¶é—´æˆ³ - ä»»åŠ¡ä¼šåœ¨ç›¸åŒ/ç›¸è¿‘çš„æ—¶é—´å¼€å§‹\n";
echo "2. çœ‹æ€»è€—æ—¶ - å¹¶å‘æ‰§è¡Œæ—¶é—´ â‰ˆ æœ€æ…¢ä»»åŠ¡çš„æ—¶é—´ï¼Œä¸æ˜¯æ‰€æœ‰ä»»åŠ¡æ—¶é—´ä¹‹å’Œ\n";
echo "3. çœ‹è¾“å‡ºé¡ºåº - ä»»åŠ¡ä¼šäº¤é”™æ‰§è¡Œï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå®Œæˆå†æ‰§è¡Œä¸‹ä¸€ä¸ª\n";
echo "4. çœ‹æ€§èƒ½æå‡ - å¹¶å‘æ‰§è¡Œé€šå¸¸æ¯”é¡ºåºæ‰§è¡Œå¿«æ•°å€\n\n";

echo "ğŸ’¡ å…³é”®ç†è§£ï¼š\n";
echo "- å¼‚æ­¥ = ä¸ç­‰å¾…ï¼Œç«‹å³è¿”å›ï¼Œä»»åŠ¡åœ¨åå°æ‰§è¡Œ\n";
echo "- å¹¶å‘ = å¤šä¸ªä»»åŠ¡åŒæ—¶è¿›è¡Œï¼ˆåœ¨ç­‰å¾… I/O æ—¶åˆ‡æ¢ï¼‰\n";
echo "- PHP Fiber = åä½œå¼å¹¶å‘ï¼Œä¸æ˜¯å¤šçº¿ç¨‹å¹¶è¡Œ\n";

